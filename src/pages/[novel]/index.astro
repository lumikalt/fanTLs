---
import "@styles/chapter.scss";
import BaseHead from "@components/BaseHead.astro";
import Header from "@components/Header.astro";
import TooltipText from "@components/TooltipText.astro";
import novels from "@novels.yaml";
import getAllCollections from "@utils/getAllCollections";
import parseTooltip, { eraseTooltip } from "@utils/parseTooltip";
import { Fragment } from "astro/jsx-runtime";
import ChapterList from "@components/ChapterList.astro";

export async function getStaticPaths() {
  return Object.keys(novels).map(novelKey => ({
    params: { novel: novelKey }
  }));
}

const novelKey = Astro.params.novel ?? "";
const novel = novels[novelKey];

let title = "";
let author = "";
let description = "";
let posts: any[] = [];

if (novel) {
  ({ name: title, author, description } = novel);
  // Fetch all chapters and filter for this novel
  posts = (await getAllCollections())
    .filter(entry => entry.collection === novelKey)
    .sort((a, b) => a.data.chapter - b.data.chapter);
}

// Prepare serializable posts for the client island
const safePosts = posts.map(p => ({
  slug: p.slug,
  collection: p.collection,
  data: { chapter: p.data.chapter, name: p.data.name }
}));
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={eraseTooltip(title) || "Novel Not Found"}
      description={novel ?
        `${author} - ${eraseTooltip(description)}`
      : "This novel does not exist."}
    />
  </head>
  <body>
    <Header />

    <main>
      <h1 class="title">
        {
          parseTooltip(title).map((part, idx) =>
            part.type === "text" ?
              part.value
            : <TooltipText key={idx} text={part.text} tooltip={part.tooltip} />
          )
        }
      </h1>

      <p class="description">
        {
          parseTooltip(description).map((part, idx) =>
            part.type === "text" ?
              part.value
            : <TooltipText key={idx} text={part.text} tooltip={part.tooltip} />
          )
        }
      </p>

      <br />

      <ChapterList novel={novelKey} posts={safePosts} pageSize={20} />
    </main>
  </body>
</html>
